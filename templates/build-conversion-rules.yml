spec:
  inputs:
    input_dir:
      description: "Каталог с правилами конвертации для сборки"
    output_dir:
      description: "Каталог с результатом сборки"
      default: "build/rules"
    gitrules_image:
      default: "sleemp/gitrules:1.1.2"
      description: "Образ gitrules"
    stage:
      default: "build"
---
build-conversion-rules:
  stage: $[[ inputs.stage ]]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'
  image: 
    name: $[[ inputs.gitrules_image ]]
    entrypoint: [""]
  script:
    - |
      set -e
      gitrules assembly $[[ inputs.input_dir ]] $[[ inputs.output_dir ]]

      if [ ! -d "$[[ inputs.output_dir ]]" ] || [ -z "$(ls -A "$[[ inputs.output_dir ]]")" ]; then
        echo "ОШИБКА: Каталог с результатом сборки '$[[ inputs.output_dir ]]' пуст или не существует."
        exit 1
      fi

      # Проверяем, что в каталоге сборки ровно один файл
      FILE_COUNT=$(find "$[[ inputs.output_dir ]]" -type f -printf '.' | wc -c)
      if [ "$FILE_COUNT" -ne 1 ]; then
        echo "ОШИБКА: В каталоге '$[[ inputs.output_dir ]]' ожидался один файл, но найдено: $FILE_COUNT."
        ls -lR "$[[ inputs.output_dir ]]"
        exit 1
      fi

      # Находим имя исходного файла
      SOURCE_FILE=$(find "$[[ inputs.output_dir ]]" -type f)

      if [ -n "$CI_COMMIT_TAG" ]; then
        ASSET_NAME="rules-$CI_COMMIT_TAG.xml"
      else
        ASSET_NAME="rules-$CI_COMMIT_SHORT_SHA.xml"
      fi
      
      # Переименовываем и перемещаем файл в корень проекта
      mv "$SOURCE_FILE" "$ASSET_NAME"

      echo "BUILD_JOB_ID=$CI_JOB_ID" >> build.env
      echo "ASSET_NAME=$ASSET_NAME" >> build.env
  artifacts:
    paths:
      - "rules-*.xml"
    expire_in: 1 week
    when: on_success
    reports:
      dotenv: build.env
  