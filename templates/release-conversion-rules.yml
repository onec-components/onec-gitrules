spec:
  inputs:
    stage:
      default: "release"
    build_job_name:
      description: "Имя джобы сборки артефакта"
      default: "build-conversion-rules"
    asset_dir:
      description: "Каталог для архивации в релиз. Должен быть равен output_dir из build-conversion-rules"
      default: "build/rules"
---
release-conversion-rules:
  stage: $[[ inputs.stage ]]
  image: registry.gitlab.com/gitlab-org/cli:latest
  script:
    - ASSET_NAME="rules-$CI_COMMIT_TAG.tar.gz"
    - tar -czf "$ASSET_NAME" "$[[ inputs.asset_dir ]]"
    - echo "Creating release $CI_COMMIT_TAG with asset $ASSET_NAME"
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: $[[ inputs.build_job_name ]]
      artifacts: true
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Правила конвертации для версии $CI_COMMIT_TAG"
    assets:
      links:
        - name: "rules-$CI_COMMIT_TAG.tar.gz"
          url: "$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/file/rules-$CI_COMMIT_TAG.tar.gz"

  