spec:
  inputs:
    stage:
      default: "release"
    build_job_name:
      description: "Имя джобы сборки артефакта"
      default: "build-conversion-rules"
    asset_dir:
      description: "Каталог для архивации в релиз. Должен быть равен output_dir из build-conversion-rules"
      default: "build/rules"
    skip_tls_verify:
      description: "Отключить проверку TLS (для self-hosted GitLab)"
      default: false
---
release-conversion-rules:
  stage: $[[ inputs.stage ]]
  variables:
    GITLAB_HOST: "$CI_SERVER_HOST"
  rules:
    - if: '$CI_COMMIT_TAG'
  image: registry.gitlab.com/gitlab-org/cli:latest
  script:
    - 'if [[ "$[[ inputs.skip_tls_verify ]]" == "true" ]]; then glab config set skip_tls_verify true --host "$GITLAB_HOST"; fi'
    - ASSET_NAME="rules-$CI_COMMIT_TAG.tar.gz"
    - tar -czf "$ASSET_NAME" "$[[ inputs.asset_dir ]]"
    - 'glab release create "$CI_COMMIT_TAG" "$ASSET_NAME" --notes "Правила конвертации для версии $CI_COMMIT_TAG."'
  needs:
    - job: $[[ inputs.build_job_name ]]
      artifacts: true
  